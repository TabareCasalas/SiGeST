// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id_usuario    Int      @id @default(autoincrement())
  nombre        String
  ci            String   @unique
  domicilio     String
  telefono      String
  correo        String   @unique
  password      String? // Contraseña hasheada con bcrypt (opcional por ahora)
  rol           String   @default("estudiante") // estudiante, docente, consultante, administrador
  nivel_acceso  Int? // Para administradores: 1=administrativo (unificado), 3=sistema (null para otros roles)
  activo        Boolean  @default(true)
  semestre      String? // Para estudiantes
  fecha_desactivacion_automatica DateTime? // Fecha en la que se desactivará automáticamente (para estudiantes)
  debe_cambiar_password Boolean @default(false) // Indica si el usuario debe cambiar su contraseña en el próximo login
  refresh_token String? // Token JWT de refresco para sesiones persistentes
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  consultantes             Consultante[]
  auditorias               Auditoria[]
  grupos_participa         UsuarioGrupo[]
  hojas_ruta               HojaRuta[]
  documentos               DocumentoAdjunto[]
  fichas_asignadas         Ficha[]            @relation("FichaDocente")
  notificaciones_recibidas Notificacion[]     @relation("NotificacionesRecibidas")
  notificaciones_enviadas  Notificacion[]     @relation("NotificacionesEnviadas")
  solicitud_reactivacion   SolicitudReactivacion?
  solicitudes_procesadas   SolicitudReactivacion[] @relation("SolicitudesProcesadas")
}

model SolicitudReactivacion {
  id_solicitud        Int      @id @default(autoincrement())
  id_usuario          Int      @unique
  estado              String   @default("pendiente") // pendiente, aprobada, rechazada
  motivo              String?  // Motivo opcional de la solicitud
  respuesta           String?  // Respuesta del administrador
  id_administrador    Int?     // Administrador que procesó la solicitud
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  usuario         Usuario  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)
  administrador   Usuario? @relation("SolicitudesProcesadas", fields: [id_administrador], references: [id_usuario])

  @@index([estado])
  @@index([created_at])
}

model Consultante {
  id_consultante Int      @id @default(autoincrement())
  id_usuario     Int      @unique
  est_civil      String
  nro_padron     Int      @unique
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  usuario  Usuario   @relation(fields: [id_usuario], references: [id_usuario])
  tramites Tramite[]
  fichas   Ficha[]
}

model Grupo {
  id_grupo    Int      @id @default(autoincrement())
  nombre      String
  descripcion String?
  activo      Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tramites       Tramite[]
  miembros_grupo UsuarioGrupo[]
  fichas         Ficha[]
}

model UsuarioGrupo {
  id_usuario_grupo Int      @id @default(autoincrement())
  id_usuario       Int
  id_grupo         Int
  rol_en_grupo     String // responsable, asistente, estudiante
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])
  grupo   Grupo   @relation(fields: [id_grupo], references: [id_grupo])

  @@unique([id_usuario, id_grupo])
  @@index([id_grupo])
  @@index([id_usuario])
}

model Tramite {
  id_tramite          Int       @id @default(autoincrement())
  id_consultante      Int
  id_grupo            Int
  num_carpeta         String    @unique // Formato: xxx/yy (ej: 001/25)
  estado              String    @default("en_tramite") // en_tramite, finalizado, pendiente, desistido
  observaciones       String?
  fecha_inicio        DateTime  @default(now())
  fecha_cierre        DateTime?
  motivo_cierre       String?
  process_instance_id String? // ID de la instancia en Camunda
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  consultante    Consultante        @relation(fields: [id_consultante], references: [id_consultante])
  grupo          Grupo              @relation(fields: [id_grupo], references: [id_grupo])
  notificaciones Notificacion[]
  hoja_ruta      HojaRuta[]
  documentos     DocumentoAdjunto[]
}

model Notificacion {
  id_notificacion   Int      @id @default(autoincrement())
  id_usuario        Int // Usuario destinatario
  id_usuario_emisor Int? // Usuario que envía (null si es automática)
  titulo            String
  mensaje           String
  tipo              String   @default("info") // info, success, warning, error
  leida             Boolean  @default(false)
  // Campos para relacionar con diferentes entidades
  tipo_entidad      String? // tramite, ficha, grupo, usuario, etc.
  id_entidad        Int? // ID de la entidad relacionada
  id_tramite        Int? // Para compatibilidad con notificaciones de trámites
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  usuario Usuario  @relation("NotificacionesRecibidas", fields: [id_usuario], references: [id_usuario])
  emisor  Usuario? @relation("NotificacionesEnviadas", fields: [id_usuario_emisor], references: [id_usuario])
  tramite Tramite? @relation(fields: [id_tramite], references: [id_tramite])

  @@index([id_usuario])
  @@index([id_usuario_emisor])
  @@index([leida])
  @@index([created_at])
  @@index([tipo_entidad, id_entidad])
}

model Auditoria {
  id_auditoria Int      @id @default(autoincrement())
  id_usuario   Int?
  tipo_entidad String // 'usuario', 'tramite', 'grupo', etc.
  id_entidad   Int? // ID de la entidad modificada
  accion       String // 'crear', 'modificar', 'desactivar', etc.
  detalles     String? // Detalles del cambio
  ip_address   String?
  created_at   DateTime @default(now())

  usuario Usuario? @relation(fields: [id_usuario], references: [id_usuario])
}

model HojaRuta {
  id_hoja_ruta    Int      @id @default(autoincrement())
  id_tramite      Int
  id_usuario      Int // Estudiante que realizó la actuación
  fecha_actuacion DateTime @default(now())
  descripcion     String // Descripción de la actuación realizada
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  tramite Tramite @relation(fields: [id_tramite], references: [id_tramite], onDelete: Cascade)
  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@index([id_tramite])
  @@index([id_usuario])
}

model DocumentoAdjunto {
  id_documento      Int      @id @default(autoincrement())
  id_tramite        Int
  id_usuario        Int // Usuario que subió el documento
  nombre_archivo    String // Nombre original del archivo
  nombre_almacenado String // Nombre del archivo en el servidor
  ruta_archivo      String // Ruta completa del archivo
  tipo_mime         String // Tipo MIME del archivo (ej: application/pdf, image/jpeg)
  tamano            Int // Tamaño del archivo en bytes
  descripcion       String? // Descripción opcional del documento
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  tramite Tramite @relation(fields: [id_tramite], references: [id_tramite], onDelete: Cascade)
  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@index([id_tramite])
  @@index([id_usuario])
}

model Ficha {
  id_ficha        Int      @id @default(autoincrement())
  id_consultante  Int
  fecha_cita      DateTime // Día para el que está citado el consultante
  hora_cita       String? // Hora de la cita (formato HH:mm)
  tema_consulta   String // Tema de la consulta
  id_docente      Int // Docente al que se deriva (decidirá el grupo)
  numero_consulta String   @unique // Formato xx/yyyy (xx secuencial, yyyy año)
  estado          String   @default("standby") // pendiente, aprobado, standby, asignada, iniciada
  id_grupo        Int? // Grupo asignado (solo cuando estado es asignada o iniciada)
  observaciones   String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  consultante Consultante @relation(fields: [id_consultante], references: [id_consultante])
  docente     Usuario     @relation("FichaDocente", fields: [id_docente], references: [id_usuario])
  grupo       Grupo?      @relation(fields: [id_grupo], references: [id_grupo])

  @@index([id_consultante])
  @@index([id_docente])
  @@index([id_grupo])
  @@index([estado])
  @@index([numero_consulta])
}
